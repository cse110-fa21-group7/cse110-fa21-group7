<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>js/preview-recipe.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="RecipeCard.html">RecipeCard</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RecipeCard.html#setPage">setPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="RecipeCard.html#setPage">setPage</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addCurated">addCurated</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addExamples">addExamples</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#addList">addList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#bindEscKey">bindEscKey</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#bindNavbarLinks">bindNavbarLinks</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#checkID">checkID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#checkValid">checkValid</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#createSections">createSections</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#currInit">currInit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#fetchFullRecipe">fetchFullRecipe</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#fetchRecipes">fetchRecipes</a></span></li><li class="nav-item"><span class="nav-item-type type-member">M</span><span class="nav-item-name"><a href="global.html#file">file</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getID">getID</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getPage">getPage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#getRecipesFromCache">getRecipesFromCache</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hasFloat">hasFloat</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#hasValue">hasValue</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#makePage">makePage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#populateForm">populateForm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#populateHTML">populateHTML</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#readRecipe">readRecipe</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#recipeCards">recipeCards</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#removeTags">removeTags</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setButtonListener">setButtonListener</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#setSearchListener">setSearchListener</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#showError">showError</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#showMessage">showMessage</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#showSuccess">showSuccess</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="global.html#spoonToASAP">spoonToASAP</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">js/preview-recipe.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// read-recipe.js
let recipe = {};
let recipeID;
window.addEventListener("DOMContentLoaded", init);

/** Initialize function, begins all of the JS code in this file */
async function init() {
  getID();
  setButtonListener();
}

/**
 * Checks if ID is in localStorage,return it back
 */
function getID() {
  const queryString = window.location.search;
  // console.log(queryString);
  const urlParams = new URLSearchParams(queryString);
  const id = urlParams.get("id");
  console.log(`id: ${id}`);
  if (id) {
    recipeID = id;
    fetchFullRecipe(recipeID);
  } else console.error("open recipe page incorrectly!!");
}

/**
 * Gets full recipe from Spoonacular API based on ID
 * @param {String} id
 * @return {null}
 */
async function fetchFullRecipe(id) {
  const storedRecipes = JSON.parse(localStorage.getItem("storedRecipes"));
  if (id in storedRecipes) {
    recipe = storedRecipes[id];
  } else {
    console.log("Fetching full recipe");
    const url = `/search/recipeId?id=${id}`;
    // Return the recipe object from spoonacular
    const res = await fetch(url); 
    console.log(res);
    const data = await res.json();
    if (data.cod === "404") {
      alert("Recipe not found");
      return;
    }
    if (data.cod === 401) {
      alert("Invalid API Key");
      return;
    }
    console.log(`Recipe:\n${data}`);
    recipe = data;
    storedRecipes[id] = spoonToASAP(data);
    localStorage.setItem("storedRecipes", JSON.stringify(storedRecipes));
  }
  populateHTML();
}

/**
 * Converts Spoonacular recipe object into ASAP recipe object
 * @param {Object} data 
 * @return {Object}
 */
function spoonToASAP(data) {
  asap = {};
  asap["title"] = data["title"];
  asap["description"] = removeTags(recipe["summary"]).substring(0, 300) + "...";
  asap["servings"] = data["servings"];
  asap["totalCost"] = (data["totalCost"] / 100).toFixed(2);
  asap["time"] = data["readyInMinutes"];
  asap["image"] = data["image"];

  ingredients = [];
  for (const dataIng of data["extendedIngredients"]) {
    ingredient = {};
    ingredient["name"] = dataIng["name"];
    ingredient["amount"] = dataIng["amount"].toFixed(2);
    ingredients.push(ingredient);
  }

  steps = [];
  for (const dataStep of data["analyzedInstructions"][0]["steps"]) {
    const step = dataStep["step"];
    steps.push(step);
  }

  return asap;
}


/**
 * Helper function, removes HTML tags from recipe summary
 * @param {String} str
 * @return {String}
 */
function removeTags(str) {
  if (str === null || str === "") return false;
  else str = str.toString();

  // Regular expression to identify HTML tags in
  // the input string. Replacing the identified
  // HTML tag with a null string.
  return str.replace(/(&lt;([^>]+)>)/gi, "");
}


/** Populate forms by ID
 * @param {int} id
 */
function populateHTML() {
  console.log(`Recipe: ${recipe["title"]}`);
  // get article element, so we can append elements
  // const article = document.getElementById("recipeTitle");

  // add title
  document.getElementById("recipeTitle").innerText = recipe["title"];

  // add Description
  let description;
  if ("description" in recipe) {
    description = recipe["description"];
  } else if ("summary" in recipe) {
    description = removeTags(recipe["summary"]).substring(0, 300) + "...";
  }
  document.getElementById("recipeDescription").innerText = description;

  const detailDiv = document.querySelector(".detail");
  const servingDiv = detailDiv.querySelector(".serving");
  const servingSpan = servingDiv.getElementsByTagName("span")[1];
  if ("servings" in recipe) {
    servingSpan.innerText = recipe["servings"];
  } else {
    servingSpan.innerText = "Servings: 1";
  }

  const costDiv = detailDiv.querySelector(".cost");
  const costSpan = costDiv.getElementsByTagName("span")[1];
  if ("totalCost" in recipe) {
    // appends dollar sign and either does division to get cents -> dollars if spoonacular or just appends price
    if (recipe["img-url"].includes("https://spoonacular.com")) {
      costSpan.innerText = `Cost: $${(recipe["totalCost"] / 100).toFixed(2)}`;
    } else {
      costSpan.innerText = `Cost: $${recipe["totalCost"]}`;
    }
  } else if ("pricePerServing" in recipe) {
    costSpan.innerText = `Cost: $${(recipe["pricePerServing"] / 100).toFixed(
      2
    )}`;
  } else {
    costSpan.innerText = "Cost: Bout tree fiddy";
  }

  const timeDiv = detailDiv.querySelector(".time");
  const timeSpan = timeDiv.getElementsByTagName("span")[1];
  if ("time" in recipe) {
    timeSpan.innerText = recipe["time"];
  } else if ("readyInMinutes" in recipe) {
    timeSpan.innerText = recipe["readyInMinutes"];
  } else {
    timeSpan.innerText = "Ready before you know it";
  }

  // add image
  const img = document.getElementById("recipeImg");

  if ("img-url" in recipe) {
    const url = recipe["img-url"];
    if (url.includes("https://i.imgur.com")) {
      // Tell imgur to resize image to medium (max 320x320) in case of large src image
      // Saves bandwidth
      const imgUrl = recipe["img-url"].split(".");
      imgUrl[imgUrl.length - 2] = imgUrl.at(-2) + "m";
      const imgUrlM = imgUrl.join(".");
      img.src = imgUrlM;
    } else {
      // Old img.src code
      img.src = url;
    }
  } else if ("image" in recipe) {
    img.src = recipe["image"];
  } else {
    // No image uploaded, set default
    img.src = "../img/default.png";
  }

  const ingList = document.getElementById("ingredient-list");
  if ("ingredients" in recipe) {
    for (const ingredient of recipe["ingredients"]) {
      const eachIng = document.createElement("div");
      eachIng.classList.add("each-ingredient");
      const label = document.createElement("label");
      label.innerText = `${ingredient["name"]} ${ingredient["amount"].toFixed(
        2
      )}`;
      label.classList.add("container");
      const input = document.createElement("input");
      input.type = "checkbox";
      const span = document.createElement("span");
      span.classList.add("checkmark");
      label.append(input, span);
      eachIng.appendChild(label);
      ingList.appendChild(eachIng);
    }
  } else if ("extendedIngredients" in recipe) {
    for (const ingredient of recipe["extendedIngredients"]) {
      const eachIng = document.createElement("div");
      eachIng.classList.add("each-ingredient");
      const label = document.createElement("label");
      label.innerText = `${ingredient["name"]} ${ingredient["amount"].toFixed(
        2
      )}`;
      label.classList.add("container");
      const input = document.createElement("input");
      input.type = "checkbox";
      const span = document.createElement("span");
      span.classList.add("checkmark");
      label.append(input, span);
      eachIng.appendChild(label);
      ingList.appendChild(eachIng);
    }
  }

  // add step list
  const stepList = document.getElementById("steps-list");
  const ul = document.createElement("ol");
  if ("steps" in recipe) {
    for (const step of recipe["steps"]) {
      ul.classList.add("orderList");
      const li = document.createElement("li");
      li.innerHTML = step;
      ul.appendChild(li);
    }
    stepList.appendChild(ul);
  } else if ("analyzedInstructions" in recipe) {
    for (const step of recipe["analyzedInstructions"][0]["steps"]) {
      ul.classList.add("orderList");
      const li = document.createElement("li");
      li.innerHTML = step["step"];
      ul.appendChild(li);
    }
    stepList.appendChild(ul);
  }
}

/** Sets event listeners */
function setButtonListener() {
  const editButton = document.getElementById("Add");
  editButton.addEventListener("click", (e) => {
    alert(`Adding recipe ID: ${recipeID}`);
    // location.href = `/updateRecipe?id=${recipeID}`;
  });

  return;
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Mon Nov 29 2021 20:00:58 GMT+0000 (Coordinated Universal Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
